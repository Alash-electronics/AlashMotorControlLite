/*
 * ═══════════════════════════════════════════════════════════════════════════
 * Motor_with_IRControl - IR пультпен моторды басқару
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * Бұл мысал AlashMotorControlLite және AlashIRControl кітапханаларының
 * бірге дұрыс жұмыс істеуін көрсетеді.
 *
 * МАҢЫЗДЫ: Arduino Uno/Nano-да Timer2 конфликтісін болдырмау үшін
 * PWM пиндері Timer0 немесе Timer1-ге қосылуы керек!
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * ДҰРЫС PWM ПИНДЕРІ (Arduino Uno/Nano):
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * ✅ Пин 5  - Timer0 (IR-мен үйлесімді)
 * ✅ Пин 6  - Timer0 (IR-мен үйлесімді)
 * ✅ Пин 9  - Timer1 (IR-мен үйлесімді)
 * ✅ Пин 10 - Timer1 (IR-мен үйлесімді)
 *
 * ❌ Пин 3  - Timer2 (IR-мен КОНФЛИКТ!)
 * ❌ Пин 11 - Timer2 (IR-мен КОНФЛИКТ!)
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * ҚОСЫЛУ СХЕМАСЫ (Arduino Uno):
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * IR қабылдағыш (TSOP1738, VS1838B т.б.):
 * ┌──────────────┐
 * │ IR Receiver  │
 * │  VS1838B     │
 * ├──────────────┤
 * │ OUT  → D7    │  // IR сигнал шығысы
 * │ GND  → GND   │
 * │ VCC  → 5V    │
 * └──────────────┘
 *
 * Мотор драйвері (L298N, DIR_PWM режимі):
 * ┌────────────────────┐
 * │ L298N Motor Driver │
 * ├────────────────────┤
 * │ IN1 (DIR) → D4     │  // Бағыт басқару
 * │ ENA (PWM) → D9     │  // ✅ Жылдамдық (Timer1 - IR-мен жұмыс істейді!)
 * │ OUT1      → Motor+ │
 * │ OUT2      → Motor- │
 * │ GND       → GND    │
 * │ 12V       → 12V    │
 * └────────────────────┘
 *
 * Немесе TB6612FNG (PWM_PWM режимі):
 * ┌──────────────────────┐
 * │ TB6612FNG Driver     │
 * ├──────────────────────┤
 * │ IN1 (PWM) → D9       │  // ✅ Timer1 пині
 * │ IN2 (PWM) → D10      │  // ✅ Timer1 пині
 * │ OUT1      → Motor+   │
 * │ OUT2      → Motor-   │
 * │ GND       → GND      │
 * │ VM        → 12V      │
 * │ VCC       → 5V       │
 * └──────────────────────┘
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * IR ПУЛЬТІНІҢ ПЕРНЕЛЕРІ (кез келген NEC протокол пульті):
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * Бұл мысалда келесі IR кодтар қолданылады:
 * - 0xFF18E7 (кнопка 2) - Алға
 * - 0xFF4AB5 (кнопка 8) - Артқа
 * - 0xFF10EF (кнопка 4) - Баяу
 * - 0xFF5AA5 (кнопка 6) - Жылдам
 * - 0xFF38C7 (кнопка 5) - Тоқтату
 *
 * Сіздің пультіңіздің кодтарын біліп алу үшін:
 * 1. AlashIRControl кітапханасының RX_SIMPLE мысалын ашыңыз
 * 2. IR кодтарды жазып алыңыз
 * 3. Осы мысалдағы кодтарды өзгертіңіз
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * АВТОР: Alash Electronics (https://alash-electronics.kz)
 * ЛИЦЕНЗИЯ: MIT
 * ═══════════════════════════════════════════════════════════════════════════
 */

#include <AlashMotorControlLite.h>
#include <AlashIRControl.h>

// ═══════════════════════════════════════════════════════════════════════════
// КОНФИГУРАЦИЯ ПИНДЕРІ
// ═══════════════════════════════════════════════════════════════════════════

#define IR_RX_PIN 7           // IR қабылдағыш пині

// Мотор пиндері - МІНДЕТТІ ТҮРДЕ Timer0 немесе Timer1 пиндерін қолданыңыз!
#if defined(ARDUINO_ARCH_ESP32)
  // ESP32-де барлық пиндер PWM-ді қолдайды, конфликт жоқ
  AlashMotorControlLite motor(PWM_PWM, 32, 33);
  #define PLATFORM_NAME "ESP32"
#else
  // Arduino Uno/Nano үшін Timer1 пиндерін қолданамыз (9, 10)
  // DIR_PWM режимі: DIR=4, PWM=9 (Timer1 - IR-мен конфликтсіз!)
  AlashMotorControlLite motor(DIR_PWM, 4, 9);

  // Немесе PWM_PWM режимі үшін:
  // AlashMotorControlLite motor(PWM_PWM, 9, 10);  // Екеуі де Timer1

  #define PLATFORM_NAME "Arduino"
#endif

// IR қабылдағыш объектісі
AlashIRControlRX irReceiver;

// ═══════════════════════════════════════════════════════════════════════════
// IR ПУЛЬТ КОДТАРЫ (өз пультіңізге сәйкес өзгертіңіз!)
// ═══════════════════════════════════════════════════════════════════════════

#define IR_FORWARD  0xFF18E7  // Алға (кнопка 2)
#define IR_BACKWARD 0xFF4AB5  // Артқа (кнопка 8)
#define IR_SLOWER   0xFF10EF  // Баяулату (кнопка 4)
#define IR_FASTER   0xFF5AA5  // Жылдамдату (кнопка 6)
#define IR_STOP     0xFF38C7  // Тоқтату (кнопка 5)

// ═══════════════════════════════════════════════════════════════════════════
// ГЛОБАЛДЫ АЙНЫМАЛЫЛАР
// ═══════════════════════════════════════════════════════════════════════════

int currentSpeed = 0;         // Ағымдағы жылдамдық (-100...+100)
const int speedStep = 20;     // Жылдамдықты өзгерту қадамы

// ═══════════════════════════════════════════════════════════════════════════
// SETUP - БАСТАПҚЫ БАПТАУ
// ═══════════════════════════════════════════════════════════════════════════

void setup() {
  Serial.begin(115200);

  delay(500);  // IR қабылдағышты тұрақтандыру үшін кідіріс

  Serial.println();
  Serial.println(F("═══════════════════════════════════════════════════════════"));
  Serial.println(F("  AlashMotorControlLite + AlashIRControl"));
  Serial.println(F("  IR пультпен моторды басқару"));
  Serial.println(F("═══════════════════════════════════════════════════════════"));
  Serial.println();
  Serial.print(F("Платформа: "));
  Serial.println(F(PLATFORM_NAME));
  Serial.println();

  // IR қабылдағышты инициализациялау
  irReceiver.begin(IR_RX_PIN);
  Serial.print(F("✓ IR қабылдағыш іске қосылды (пин "));
  Serial.print(IR_RX_PIN);
  Serial.println(F(")"));

  // Моторды инициализациялау
  Serial.print(F("✓ Мотор басқаруы дайын (режим: "));
  if (motor.getMode() == DIR_PWM) {
    Serial.println(F("DIR_PWM)"));
  } else if (motor.getMode() == PWM_PWM) {
    Serial.println(F("PWM_PWM)"));
  }

  Serial.println();
  Serial.println(F("═══════════════════════════════════════════════════════════"));
  Serial.println(F("  IR ПУЛЬТ ПЕРНЕЛЕРІ:"));
  Serial.println(F("═══════════════════════════════════════════════════════════"));
  Serial.println(F("  [2] - Алға (Forward)"));
  Serial.println(F("  [8] - Артқа (Backward)"));
  Serial.println(F("  [4] - Баяулату (Slower)"));
  Serial.println(F("  [6] - Жылдамдату (Faster)"));
  Serial.println(F("  [5] - Тоқтату (Stop)"));
  Serial.println(F("═══════════════════════════════════════════════════════════"));
  Serial.println();
  Serial.println(F("IR пультіндегі пернені басыңыз..."));
  Serial.println();

  motor.stop();  // Бастапқыда мотор тоқтатылған
}

// ═══════════════════════════════════════════════════════════════════════════
// LOOP - НЕГІЗГІ ЦИКЛ
// ═══════════════════════════════════════════════════════════════════════════

void loop() {
  // IR сигналын тексеру
  if (irReceiver.check()) {
    uint32_t irCode = irReceiver.data();  // IR кодты алу

    handleIRCommand(irCode);  // Команданы өңдеу
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// IR КОМАНДАЛАРЫН ӨҢДЕУ ФУНКЦИЯСЫ
// ═══════════════════════════════════════════════════════════════════════════

void handleIRCommand(uint32_t irCode) {
  Serial.print(F("IR код алынды: 0x"));
  Serial.print(irCode, HEX);
  Serial.print(F("  →  "));

  switch(irCode) {

    // ─────────────────────────────────────────────────────────────────────
    case IR_FORWARD:  // Алға
    // ─────────────────────────────────────────────────────────────────────
      if (currentSpeed <= 0) {
        currentSpeed = speedStep;  // Егер тұрса немесе артқа қозғалса
      }
      Serial.print(F("АЛҒА, жылдамдық: "));
      Serial.println(currentSpeed);
      motor.setSpeed(currentSpeed);
      break;

    // ─────────────────────────────────────────────────────────────────────
    case IR_BACKWARD:  // Артқа
    // ─────────────────────────────────────────────────────────────────────
      if (currentSpeed >= 0) {
        currentSpeed = -speedStep;  // Егер тұрса немесе алға қозғалса
      }
      Serial.print(F("АРТҚА, жылдамдық: "));
      Serial.println(currentSpeed);
      motor.setSpeed(currentSpeed);
      break;

    // ─────────────────────────────────────────────────────────────────────
    case IR_FASTER:  // Жылдамдату
    // ─────────────────────────────────────────────────────────────────────
      if (currentSpeed > 0) {
        // Алға қозғалыс - жылдамдықты арттырамыз
        currentSpeed = min(100, currentSpeed + speedStep);
      } else if (currentSpeed < 0) {
        // Артқа қозғалыс - жылдамдықты арттырамыз (абсолют мәні бойынша)
        currentSpeed = max(-100, currentSpeed - speedStep);
      } else {
        // Тұрса - алға бастаймыз
        currentSpeed = speedStep;
      }
      Serial.print(F("ЖЫЛДАМДАТУ: "));
      Serial.println(currentSpeed);
      motor.setSpeed(currentSpeed);
      break;

    // ─────────────────────────────────────────────────────────────────────
    case IR_SLOWER:  // Баяулату
    // ─────────────────────────────────────────────────────────────────────
      if (currentSpeed > 0) {
        // Алға қозғалыс - баяулатамыз
        currentSpeed = max(0, currentSpeed - speedStep);
      } else if (currentSpeed < 0) {
        // Артқа қозғалыс - баяулатамыз (абсолют мәні бойынша)
        currentSpeed = min(0, currentSpeed + speedStep);
      }
      Serial.print(F("БАЯУЛАТУ: "));
      Serial.println(currentSpeed);

      if (currentSpeed == 0) {
        motor.stop();
        Serial.println(F("  (мотор тоқтатылды)"));
      } else {
        motor.setSpeed(currentSpeed);
      }
      break;

    // ─────────────────────────────────────────────────────────────────────
    case IR_STOP:  // Тоқтату
    // ─────────────────────────────────────────────────────────────────────
      currentSpeed = 0;
      motor.stop();
      Serial.println(F("ТОҚТАТУ"));
      break;

    // ─────────────────────────────────────────────────────────────────────
    default:  // Белгісіз команда
    // ─────────────────────────────────────────────────────────────────────
      Serial.println(F("(белгісіз команда)"));
      Serial.println(F("   Өз IR кодтарыңызды анықтау үшін RX_SIMPLE мысалын қолданыңыз"));
      break;
  }

  Serial.println();
}

/*
 * ═══════════════════════════════════════════════════════════════════════════
 * ЕСКЕРТУЛЕР:
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * 1. TIMER КОНФЛИКТІСІ:
 *    Arduino Uno/Nano-да AlashIRControl Timer2-ні қолданады.
 *    Сондықтан PWM үшін ТЕК Timer0 (5, 6) немесе Timer1 (9, 10) пиндерін қолданыңыз!
 *
 *    ❌ ҚАТЕ: AlashMotorControlLite motor(DIR_PWM, 4, 3);   // 3-пин Timer2!
 *    ✅ ДҰРЫС: AlashMotorControlLite motor(DIR_PWM, 4, 9);  // 9-пин Timer1!
 *
 * 2. ESP32:
 *    ESP32-де бұл проблема жоқ - барлық пиндер PWM үшін қолданыла алады.
 *
 * 3. IR КОДТАРЫ:
 *    Әр пульттің өзінің IR кодтары бар. Өз кодтарыңызды біліп алу үшін:
 *    - AlashIRControl → examples → RX_SIMPLE мысалын ашыңыз
 *    - IR пультіндегі пернелерді басып, кодтарды жазып алыңыз
 *    - Осы файлдағы #define IR_FORWARD, IR_BACKWARD т.б. өзгертіңіз
 *
 * 4. ҚАУІПСІЗДІК:
 *    Моторды бірден тоқтату үшін brake() әдісін қолдануға болады:
 *    motor.brake();  // Жылдам тежеу (тұрақсыздық болса ауыстырыңыз)
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * ҚОСЫМША АҚПАРАТ:
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * Веб-сайт: https://alash-electronics.kz
 * GitHub: https://github.com/Alash-electronics/AlashMotorControlLite
 * Қолдау: support@alash-electronics.kz
 *
 * ═══════════════════════════════════════════════════════════════════════════
 */
