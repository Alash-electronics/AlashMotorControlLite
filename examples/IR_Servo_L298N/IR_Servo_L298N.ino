/*
 * ═══════════════════════════════════════════════════════════════════════════
 * IR_Servo_L298N - IR + Серво + Екі мотор (L298N)
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * Бұл мысал Arduino Uno-да үш кітапхананы бірге қолдануды көрсетеді:
 * - AlashIRControl (IR қабылдағыш)
 * - Servo (сервопривод)
 * - AlashMotorControlLite (екі DC мотор L298N арқылы)
 *
 * МАҢЫЗДЫ: Timer конфликтісін болдырмау үшін дұрыс пиндерді таңдау керек!
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * TIMER КОНФЛИКТІСІ ТУРАЛЫ:
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * Arduino Uno/Nano-да 3 таймер бар:
 *
 * Timer0 (пин 5, 6)   → millis(), delay() үшін қолданылады
 * Timer1 (пин 9, 10)  → Servo кітапханасы қолданады
 * Timer2 (пін 3, 11)  → AlashIRControl қолданады
 *
 * Шешім: Моторлар үшін Timer0 пиндерін (5, 6) қолданамыз!
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * ҚОСЫЛУ СХЕМАСЫ - Arduino Uno + L298N + Servo + IR
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * ┌─────────────────────────────────────────────────────────────────────────┐
 * │ L298N МОТОР ДРАЙВЕРІ (екі мотор)                                        │
 * ├─────────────────────────────────────────────────────────────────────────┤
 * │                                                                         │
 * │ МОТОР A (сол):                                                          │
 * │   IN1  → D2    (бағыт 1)                                                │
 * │   IN2  → D4    (бағыт 2)                                                │
 * │   ENA  → D5    (PWM жылдамдық - Timer0) ✅                              │
 * │   OUT1 → Motor A+                                                       │
 * │   OUT2 → Motor A-                                                       │
 * │                                                                         │
 * │ МОТОР B (оң):                                                           │
 * │   IN3  → D8    (бағыт 1)                                                │
 * │   IN4  → D12   (бағыт 2)                                                │
 * │   ENB  → D6    (PWM жылдамдық - Timer0) ✅                              │
 * │   OUT3 → Motor B+                                                       │
 * │   OUT4 → Motor B-                                                       │
 * │                                                                         │
 * │ Қуат:                                                                   │
 * │   GND  → GND (Arduino GND-ке қосыңыз)                                  │
 * │   +12V → 7-12V батарея (моторлар үшін)                                 │
 * │   +5V  → Arduino 5V (логика үшін, jumper қойыңыз)                      │
 * └─────────────────────────────────────────────────────────────────────────┘
 *
 * ┌─────────────────────────────────────────────────────────────────────────┐
 * │ SERVO (SG90 немесе MG90S)                                               │
 * ├─────────────────────────────────────────────────────────────────────────┤
 * │   Signal (оранжевый/сары) → D9  (Timer1 - Servo кітапханасы)           │
 * │   VCC (қызыл)             → 5V                                          │
 * │   GND (қоңыр)             → GND                                         │
 * └─────────────────────────────────────────────────────────────────────────┘
 *
 * ┌─────────────────────────────────────────────────────────────────────────┐
 * │ IR ҚАБЫЛДАҒЫШ (VS1838B, TSOP1738)                                       │
 * ├─────────────────────────────────────────────────────────────────────────┤
 * │   OUT (сигнал)  → D7                                                    │
 * │   GND           → GND                                                   │
 * │   VCC           → 5V                                                    │
 * └─────────────────────────────────────────────────────────────────────────┘
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * IR ПУЛЬТ КОМАНДАЛАРЫ:
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * [2] - Алға        [↑] - Серво оңға
 * [4] - Солға       [5] - Тоқтату
 * [6] - Оңға        [↓] - Серво солға
 * [8] - Артқа       [OK] - Серво ортасына
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * АВТОР: Alash Electronics (https://alash-electronics.kz)
 * ЛИЦЕНЗИЯ: MIT
 * ═══════════════════════════════════════════════════════════════════════════
 */

#include <AlashMotorControlLite.h>
#include <AlashIRControl.h>
#include <Servo.h>

// ═══════════════════════════════════════════════════════════════════════════
// ПИНДЕРДІ КОНФИГУРАЦИЯЛАУ
// ═══════════════════════════════════════════════════════════════════════════

// IR қабылдағыш
#define IR_RX_PIN 7

// Servo
#define SERVO_PIN 9

// L298N Motor A (сол жақ мотор)
#define MOTOR_A_IN1 2    // Бағыт 1
#define MOTOR_A_IN2 4    // Бағыт 2
#define MOTOR_A_ENA 5    // PWM (Timer0) ✅

// L298N Motor B (оң жақ мотор)
#define MOTOR_B_IN3 8    // Бағыт 1
#define MOTOR_B_IN4 12   // Бағыт 2
#define MOTOR_B_ENB 6    // PWM (Timer0) ✅

// ═══════════════════════════════════════════════════════════════════════════
// ОБЪЕКТІЛЕР
// ═══════════════════════════════════════════════════════════════════════════

// Екі мотор - DIR_DIR_PWM режимі (3 пин әрқайсысы)
AlashMotorControlLite motorLeft(DIR_DIR_PWM, MOTOR_A_IN1, MOTOR_A_IN2, MOTOR_A_ENA);
AlashMotorControlLite motorRight(DIR_DIR_PWM, MOTOR_B_IN3, MOTOR_B_IN4, MOTOR_B_ENB);

// IR қабылдағыш
AlashIRControlRX irReceiver;

// Servo
Servo myServo;

// ═══════════════════════════════════════════════════════════════════════════
// IR ПУЛЬТ КОДТАРЫ (өз пультіңізге сәйкес өзгертіңіз!)
// ═══════════════════════════════════════════════════════════════════════════

#define IR_FORWARD   0xFF18E7  // Кнопка 2 - Алға
#define IR_BACKWARD  0xFF4AB5  // Кнопка 8 - Артқа
#define IR_LEFT      0xFF10EF  // Кнопка 4 - Солға бұрылу
#define IR_RIGHT     0xFF5AA5  // Кнопка 6 - Оңға бұрылу
#define IR_STOP      0xFF38C7  // Кнопка 5 - Тоқтату

#define IR_SERVO_LEFT  0xFFA857  // Кнопка ↓ - Серво солға
#define IR_SERVO_RIGHT 0xFF629D  // Кнопка ↑ - Серво оңға
#define IR_SERVO_CENTER 0xFF02FD // Кнопка OK - Серво ортасына

// ═══════════════════════════════════════════════════════════════════════════
// ГЛОБАЛДЫ АЙНЫМАЛЫЛАР
// ═══════════════════════════════════════════════════════════════════════════

int motorSpeed = 60;        // Мотор жылдамдығы (0-100)
int servoAngle = 90;        // Servo бұрышы (0-180, 90=ортасы)

// ═══════════════════════════════════════════════════════════════════════════
// SETUP - БАСТАПҚЫ БАПТАУ
// ═══════════════════════════════════════════════════════════════════════════

void setup() {
  Serial.begin(115200);
  delay(500);

  Serial.println();
  Serial.println(F("═══════════════════════════════════════════════════════════"));
  Serial.println(F("  IR + Servo + L298N (Екі мотор)"));
  Serial.println(F("  AlashMotorControlLite Demo"));
  Serial.println(F("═══════════════════════════════════════════════════════════"));
  Serial.println();

  // ─────────────────────────────────────────────────────────────────────────
  // IR қабылдағышты іске қосу
  // ─────────────────────────────────────────────────────────────────────────
  irReceiver.begin(IR_RX_PIN);
  Serial.print(F("✓ IR қабылдағыш дайын (пин "));
  Serial.print(IR_RX_PIN);
  Serial.println(F(", Timer2)"));

  // ─────────────────────────────────────────────────────────────────────────
  // Servo іске қосу
  // ─────────────────────────────────────────────────────────────────────────
  myServo.attach(SERVO_PIN);
  myServo.write(servoAngle);  // Бастапқы позиция - ортасында
  Serial.print(F("✓ Servo дайын (пин "));
  Serial.print(SERVO_PIN);
  Serial.println(F(", Timer1)"));

  // ─────────────────────────────────────────────────────────────────────────
  // Моторларды іске қосу
  // ─────────────────────────────────────────────────────────────────────────
  motorLeft.stop();
  motorRight.stop();
  Serial.println(F("✓ Моторлар дайын (PWM пиндер 5, 6 - Timer0)"));
  Serial.print(F("  Сол мотор: IN1="));
  Serial.print(MOTOR_A_IN1);
  Serial.print(F(", IN2="));
  Serial.print(MOTOR_A_IN2);
  Serial.print(F(", ENA(PWM)="));
  Serial.println(MOTOR_A_ENA);
  Serial.print(F("  Оң мотор:  IN3="));
  Serial.print(MOTOR_B_IN3);
  Serial.print(F(", IN4="));
  Serial.print(MOTOR_B_IN4);
  Serial.print(F(", ENB(PWM)="));
  Serial.println(MOTOR_B_ENB);

  Serial.println();
  Serial.println(F("═══════════════════════════════════════════════════════════"));
  Serial.println(F("  IR ПУЛЬТ КОМАНДАЛАРЫ:"));
  Serial.println(F("═══════════════════════════════════════════════════════════"));
  Serial.println(F("  [2] - Алға           [↑] - Серво оңға"));
  Serial.println(F("  [4] - Солға          [5] - Тоқтату"));
  Serial.println(F("  [6] - Оңға           [↓] - Серво солға"));
  Serial.println(F("  [8] - Артқа          [OK] - Серво ортасына"));
  Serial.println(F("═══════════════════════════════════════════════════════════"));
  Serial.println();
  Serial.println(F("IR пультін қолданыңыз..."));
  Serial.println();
}

// ═══════════════════════════════════════════════════════════════════════════
// LOOP - НЕГІЗГІ ЦИКЛ
// ═══════════════════════════════════════════════════════════════════════════

void loop() {
  // IR сигналын тексеру
  if (irReceiver.check()) {
    uint32_t irCode = irReceiver.data();
    handleIRCommand(irCode);
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// IR КОМАНДАЛАРЫН ӨҢДЕУ
// ═══════════════════════════════════════════════════════════════════════════

void handleIRCommand(uint32_t irCode) {
  Serial.print(F("IR: 0x"));
  Serial.print(irCode, HEX);
  Serial.print(F("  →  "));

  switch(irCode) {

    // ───────────────────────────────────────────────────────────────────────
    // МОТОР КОМАНДАЛАРЫ
    // ───────────────────────────────────────────────────────────────────────

    case IR_FORWARD:  // Алға
      motorLeft.setSpeed(motorSpeed);
      motorRight.setSpeed(motorSpeed);
      Serial.print(F("АЛҒА (жылдамдық "));
      Serial.print(motorSpeed);
      Serial.println(F(")"));
      break;

    case IR_BACKWARD:  // Артқа
      motorLeft.setSpeed(-motorSpeed);
      motorRight.setSpeed(-motorSpeed);
      Serial.print(F("АРТҚА (жылдамдық "));
      Serial.print(motorSpeed);
      Serial.println(F(")"));
      break;

    case IR_LEFT:  // Солға бұрылу (сол мотор артқа, оң алға)
      motorLeft.setSpeed(-motorSpeed / 2);
      motorRight.setSpeed(motorSpeed);
      Serial.println(F("СОЛҒА БҰРЫЛУ"));
      break;

    case IR_RIGHT:  // Оңға бұрылу (оң мотор артқа, сол алға)
      motorLeft.setSpeed(motorSpeed);
      motorRight.setSpeed(-motorSpeed / 2);
      Serial.println(F("ОҢҒА БҰРЫЛУ"));
      break;

    case IR_STOP:  // Тоқтату
      motorLeft.stop();
      motorRight.stop();
      Serial.println(F("ТОҚТАТУ"));
      break;

    // ───────────────────────────────────────────────────────────────────────
    // SERVO КОМАНДАЛАРЫ
    // ───────────────────────────────────────────────────────────────────────

    case IR_SERVO_LEFT:  // Серво солға
      servoAngle -= 15;
      servoAngle = constrain(servoAngle, 0, 180);
      myServo.write(servoAngle);
      Serial.print(F("СЕРВО СОЛҒА (бұрыш "));
      Serial.print(servoAngle);
      Serial.println(F("°)"));
      break;

    case IR_SERVO_RIGHT:  // Серво оңға
      servoAngle += 15;
      servoAngle = constrain(servoAngle, 0, 180);
      myServo.write(servoAngle);
      Serial.print(F("СЕРВО ОҢҒА (бұрыш "));
      Serial.print(servoAngle);
      Serial.println(F("°)"));
      break;

    case IR_SERVO_CENTER:  // Серво ортасына
      servoAngle = 90;
      myServo.write(servoAngle);
      Serial.println(F("СЕРВО ОРТАСЫНА (90°)"));
      break;

    // ───────────────────────────────────────────────────────────────────────
    // БЕЛГІСІЗ КОМАНДА
    // ───────────────────────────────────────────────────────────────────────

    default:
      Serial.println(F("(белгісіз команда)"));
      Serial.println(F("   Өз IR кодтарыңызды анықтау үшін RX_SIMPLE мысалын қолданыңыз"));
      break;
  }
}

/*
 * ═══════════════════════════════════════════════════════════════════════════
 * TIMER КОНФЛИКТІСІН ТҮСІНДІРУ:
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * Arduino Uno-да 3 hardware timer бар:
 *
 * ┌────────┬──────────────┬──────────────────────────────────────────────┐
 * │ Timer  │ PWM пиндер   │ Қолданылатын жері                            │
 * ├────────┼──────────────┼──────────────────────────────────────────────┤
 * │ Timer0 │ 5, 6         │ millis(), delay() (бірақ PWM-ге де болады!)  │
 * │ Timer1 │ 9, 10        │ Servo кітапханасы (біз қолданамыз)           │
 * │ Timer2 │ 3, 11        │ AlashIRControl (біз қолданамыз)              │
 * └────────┴──────────────┴──────────────────────────────────────────────┘
 *
 * ШЕШІМ: Моторлар үшін Timer0 пиндерін (5, 6) қолданамыз!
 *
 * Timer0-ды PWM үшін қолдансақ, millis() мен delay() әлі де жұмыс істейді,
 * бірақ микросекундтық дәлдік аздап төмендейді (көп жағдайда проблема емес).
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * ЕГЕР TIMER0-ДЫ ҚОЛДАНҒЫҢЫЗ КЕЛМЕСЕ:
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * 1. Arduino Mega-ға көшіңіз (15 PWM пині, 6 timer!)
 *    - Timer3, 4, 5 IR мен Servo-мен конфликт жасамайды
 *
 * 2. ESP32-ге көшіңіз (бәрі конфликтсіз жұмыс істейді!)
 *    - 16 LEDC PWM каналы (hardware timer-лермен бөлек)
 *
 * 3. ServoTimer2 кітапханасын қолданыңыз:
 *    - Timer1-ді босатады, моторлар үшін 9, 10 пиндерін қолдануға болады
 *    - https://github.com/nabontra/ServoTimer2
 *
 * ═══════════════════════════════════════════════════════════════════════════
 * ҚОСЫМША АҚПАРАТ:
 * ═══════════════════════════════════════════════════════════════════════════
 *
 * Веб-сайт: https://alash-electronics.kz
 * GitHub: https://github.com/Alash-electronics/AlashMotorControlLite
 * Қолдау: support@alash-electronics.kz
 *
 * ═══════════════════════════════════════════════════════════════════════════
 */
